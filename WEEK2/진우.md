# transport layer : UDP vs TCP

트랜스포트 계층은 두가지로 구분되는 프로토콜을 제공한다.

UDP와 TCP이다. 

UDP는 비 신뢰적이고 비 연결형이고 TCP는 신뢰적이고 연결지향형 서비스이다.

트랜스포트 계층은 애플리케이션 계층과 네트워크 계층 사이에 존재하는데 이 둘사이에 데이터 전달 역할을 맡고 있다.

네트워크 계층이 종단간 데이터 전송을 목적으로 하고 있다면 트랜스포트 계층은 종단간 프로세스의 데이터 전송을 담당하고 있다.

즉 네트워크 계층의 데이터를 데이터의 최종 목적지인 프로세스에게 위임하는 역할을 담당하는 것이다.

네트워크 계층과 애플리케이션 계층 사이에는 소켓이 존재한다. 이 소켓은 여러개가 존재할 수 있으며 데이터 세그먼트를 정확한 소켓에 전달해주는 것을 역다중화(demultiplexing)라고 부른다.

반대로 애플리케이션 계층의 데이터에 헤더정보를 붙여서 네트워크 계층으로 보내는 것을 다중화(multiplexing)라고 부른다.

Udp는 목적지 포트번호와만 가지고 소켓에 세그먼트를 바인딩한다. TCP는 출발지 포트번호, IP, 목적지 포트번호, IP 이렇게 네가지 값에 의해 소켓 바인딩을 진행한다. 

UDP는 헤더정보로 8바이트의 정보를 담고 있다. 츨빌지 포트번호와 목적지 포트번호, 길이, 체크섬 이렇게 총 4가지 필드에 대해서 각각 2바이트씩 데이터를 가지고 있다.

TCP는 20바이트의 헤더정보를 가지고 있다. 출발지 포트번호, 목적지포트번호, 순서번호, 확인응답번호 등등 확인응답번호와 순서번호는 데이터의 전송이 어디까지 이루어졌는지 파악하고 손실된 데이터를 재전송하는데 사용된다.

TCP가 어떻게 신뢰적인 데이터 전송을 진행하는가는 크게 3가지로 볼 수 있다.

##### 흐름제어

TCP는 수신자와 송신자가 윈도우 사이즈를 협상해서 데이터를 전송한다. 수신측에 맞춰서 윈도우 사이즈를 협상하며 버퍼 오버플로우로 패킷이 손실되지 않게끔 전송할 데이터의 사이즈를 조절하는 것이다. sliding 윈도우는 여러개의 세그먼트를 포함할 수 있으며 ACK는 각각의 세그먼트들에 대해서 받는다.

##### 재전송

TCP는 ACK정보를 사용해서 전송이 제대로 확인되지 않는 패킷들을 재전송 한다. 세그먼트의 타임아웃을 설정하고 해당 타임아웃 내에 ACK가 도착하지 않으면 패킷이 전송되지 않은 것으로 간주하여 재전송한다. 수신 측에서는 중복된 패킷이 도착한다면 첫번째 데이터만 취하고 나머지는 전부 버린다. 송신자는 타임아웃이 지나지 않았음에도 재전송을 할때가 있는데 중복 ACK를 3개 받으면 데이터를 바로 재전송하여 데이터 전송의 지연을 막는다. 중복 ACK를 받았다는 뜻은 중간에 데이터가 손실되어서 그 이후에 데이터도 손실된 데이터 직전 데이터의 ACK가 응답으로 오기 때문이다. 

##### 에러 체크

TCP는 체크섬을 계산해서 데이터의 무결성을 확인한다. 수신자는 데이터를 기반으로 체크섬을 계산하고 이것이 송신자가 보낸 체크섬 값과 같을때에만 해당 데이터가 무결하다고 판단한다. 만약 에러가 발생했다고 판단하면 수신자는 해당 데이터를 버린다.

# 웹 서버의 소켓 관리

tcp연결에서 소켓은 많이 생성될 수 있다. 요청이 들어올때마다 소켓을 새로 생성하고 요청이 끝나고 소켓을 닫는 일련의 과정들은 overhead가 발생할 수 있다.

보통 이는 커널에서 최적화가 진행되어있다. 왜 커널에서 진행되는가 하면 소켓의 생성과 삭제는 커널의 역할이기 때문이다.

보통 웹서버는 소켓 풀을 운용하며 소켓을 요청이 올때마다 생성하는 것이 아닌 미리 생성해둔 소켓 풀에서 소켓을 꺼내와서 사용한다. 또한 keep-alive전략을 사용하여 소켓을 요청이 끝난후 바로 닫는 것이 아닌 일정시간 유지하는 것을 통해 소켓의 생성 삭제의 오버헤드를 줄일 수 있다.

# 혼잡제어

TCP는 혼잡제어를 위해서 다음과 같은 기능들을 제공합니다.

1. slow start

TCP 커넥션의 시작에서는 전송자는 작은양의 데이터를 보내고 점차 데이터 양을 늘려갑니다. 이는 센더에게 네트워크 혼잡을 유발하지 않는 가장 큰 데이터 양을 결정할 수 있게 해줍니다.

2. ACK based control flow

전송자는 ACK를 모니터링하여 ACK가 얼마나 빠르게 응답하는지를 관찰하여 데이터 전송률을 조절할 수 있습니다.

3. Congestion avoidance

만약 센더가 네트워크 혼잡의 발생을 감지했다면 전송하는 데이터양을 줄여서 혼잡을 줄이는데 기여할 수 있습니다. 센더는 중복 ACK나 timeout, ACK rate, RTT 타임등을 통해서 혼잡을 계산해볼 수 있습니다.



### 질문 목록

TCP가 신뢰적인 데이터 전송을 어떻게 하는지 설명해보시오

TCP는 어떻게 흐름제어를 구현하나요? 그리고 윈도우 사이즈는 무엇인가요

TCP의 재전송 메커니즘에 대해서 설명해보세요

TCP는 혼잡제어를 어떻게 관리하나요? 네트워크 혼잡을 예방하기 위한 메커니즘은 무엇인가요?

UDP와 TCP의 차이를 설명해보세요

여러개의 프로세스가 호스트에 존재할때 트랜스포트 레이어는 어떻게 세그먼트를 프로세스에게 전달하나요?

많은 소켓의 생성과 삭제에서 발생하는 오버헤드를 줄일 수 있는 방법은 무엇이 있을까요?

N+1번의 세그먼트에 대한 ACK가 도착하고 N에 대한 ACK는 도착하지 않았을떄 TCP는 어떻게 동작하는가?







